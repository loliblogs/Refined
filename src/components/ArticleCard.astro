---
import Calendar from '@phosphor-icons/core/assets/regular/calendar.svg';
import Tag from '@phosphor-icons/core/assets/regular/tag.svg';
import ArrowClockwise from '@phosphor-icons/core/assets/regular/arrow-clockwise.svg';

import { getSiteConfig } from '@/config/site.config';
import type { Post } from '@/types/content';
import { getPostUrl, getTagUrl, getArchiveUrl } from '@/utils/collection-paths';
import { formatDate } from '@/utils/date-helpers';

import ExcerptExtractor from './ExcerptExtractor.astro';
import CachedContent from './CachedContent.astro';

export interface Props {
  post: Post;
  showExcerpt?: boolean;
  isFirst?: boolean;
}

const { post, showExcerpt = true, isFirst = false } = Astro.props;

const config = getSiteConfig(post.collection);

// 摘要文本：generated 类型动态生成，其他类型使用固定文本
const excerptText = post.excerptSource.type === 'generated'
  ? null
  : post.excerptSource.text;

// "阅读更多"按钮：generated 类型根据 hasMoreTag 判断，其他类型总是显示
const needsReadMore = post.excerptSource.type === 'generated'
  ? post.excerptSource.hasMoreTag
  : true;

// 获取Content组件（只在需要时）
const shouldRenderContent = showExcerpt && !excerptText;
const Content = shouldRenderContent
  ? post.Content
  : null;

// 使用动态路径生成（消除硬编码）
const postUrl = getPostUrl(post.slug, post.collection);
const excerptLink = config.excerpt_link;
---

<article
  class:list={[
    `
      pb-10
      max-lg:pb-5
    `,
    { '-mt-px border-t border-line pt-10 max-lg:pt-5': !isFirst },
  ]}
>
  {/* 文章头部 */}
  <header>
    <h1 class="mb-2 text-[2rem] font-normal">
      <a
        href={postUrl}
        class="
          text-primary no-underline transition-colors duration-200
          hover:text-link-hover
        "
      >
        {post.title}
      </a>
    </h1>

    {/* 文章元信息 */}
    <div class="
      flex flex-wrap items-center gap-4 pt-2 text-sm
      max-lg:text-xs
    "
    >
      {/* 日期 */}
      <a
        href={`${getArchiveUrl(post.collection)}?focus=${formatDate(post.date)}`}
        class="
          flex items-center text-muted no-underline transition-colors
          duration-200
          hover:text-primary
        "
      >
        <Calendar width="1rem" height="1rem" />
        <time datetime={post.date.toISOString()} class="ml-1.5">
          {formatDate(post.date)}
        </time>
      </a>

      {post.updated && (
        <span
          class="
            flex items-center text-muted no-underline transition-colors
            duration-200
          "
        >
          <ArrowClockwise width="1rem" height="1rem" />
          <time datetime={post.updated.toISOString()} class="ml-1.5">
            {formatDate(post.updated)}
          </time>
        </span>
      )}

      {/* 标签 */}
      {post.tags.length > 0 && (
        <div class="flex list-none items-center overflow-hidden text-muted">
          <Tag width="1rem" height="1rem" />
          {post.tags.map((tag, tagIndex) => (
            <>
              <a
                href={getTagUrl(tag, post.collection)}
                class="
                  ml-1.5 text-muted no-underline transition-colors
                  hover:text-primary
                "
              >
                {tag}
              </a>
              {tagIndex < post.tags.length - 1 && (
                <span class="text-muted">,</span>
              )}
            </>
          ))}
        </div>
      )}
    </div>
  </header>

  {/* 文章内容/摘要 */}
  {showExcerpt && (
    <div class="mt-5">
      <div class="mb-4 leading-relaxed text-secondary">
        {excerptText
          ? (
              <p {...(post.lang && { lang: post.lang })}>{excerptText}</p>
            )
          : Content && (
            <div data-markdown {...(post.lang && { lang: post.lang })}>
              <ExcerptExtractor>
                <CachedContent collection={post.collection} cacheKey={post.id}>
                  <Content />
                </CachedContent>
              </ExcerptExtractor>
            </div>
          )}
      </div>

      {/* 只在内容不是完整显示时才显示继续阅读按钮 */}
      {excerptLink && needsReadMore && (
        <div class="text-right">
          <a
            href={post.excerptSource.type === 'generated' ? `${postUrl}#more` : postUrl}
            class="
              inline-block rounded-sm border border-line px-3 py-1.5 text-sm
              leading-none text-muted no-underline transition-colors
              duration-300
              hover:bg-hover hover:no-underline
            "
          >
            {excerptLink}
          </a>
        </div>
      )}
    </div>
  )}
</article>
