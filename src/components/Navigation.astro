---
import Files from '@phosphor-icons/core/assets/regular/files.svg';
import List from '@phosphor-icons/core/assets/regular/list.svg';

import { getSiteConfig } from '@/config/site.config';
import type { CollectionName } from '@/types/content';
import { getBasePath, getFullPath, isRootPath } from '@/utils/collection-paths';

import NavigationController from './NavigationController';

interface Props {
  collection?: CollectionName | undefined;
}

const { collection = 'post' } = Astro.props;
const config = getSiteConfig(collection);
const homePath = getBasePath(collection);
const currentPath = Astro.url.pathname;

// 静态计算导航项是否激活
function isNavActive(path: string, recursive: boolean): boolean {
  if (recursive) {
    return currentPath === path
      || (!isRootPath(path) && currentPath.startsWith(`${path}/`));
  }
  return currentPath === path;
}
---

<nav
  data-nav
  class="
    relative h-full w-nav shrink-0 bg-surface-nav
    max-lg:fixed max-lg:top-0 max-lg:z-10 max-lg:h-auto max-lg:w-full
    print:static print:h-auto print:w-full
    forced-colors:border-l
    forced-colors:max-lg:border-y forced-colors:max-lg:border-l-0
  "
>
  {/* 移动端顶部栏 */}
  <div
    data-nav-mobile-bar
    class="
      hidden h-11 items-center justify-center bg-surface-nav
      max-lg:flex
      print:flex
    "
  >
    <label
      for="--sidebar-toggle"
      class="
        m-0 flex size-11 shrink-0 cursor-pointer items-center justify-center
        bg-transparent text-primary transition-colors duration-100 ease-in-out
        hover:bg-active
        forced-colors:transition-none
        forced-colors:hover:text-[Highlight]
        [#--sidebar-toggle:focus-visible~[data-nav]_&]:ring-2
        [#--sidebar-toggle:focus-visible~[data-nav]_&]:ring-primary
      "
    >
      <Files width="1.25rem" height="1.25rem" />
      <span class="sr-only">切换侧边栏</span>
    </label>
    <a
      href={homePath}
      class="
        m-0 flex h-11 min-w-0 flex-1 items-center justify-center truncate
        text-center text-2xl font-bold text-primary no-underline
        transition-colors duration-100 ease-in-out
        hover:text-secondary
        forced-colors:border-x forced-colors:transition-none
        forced-colors:hover:text-[Highlight]
      "
    >
      {config.title}
    </a>
    <label
      for="--menu-toggle"
      class="
        m-0 flex size-11 shrink-0 cursor-pointer items-center justify-center
        bg-transparent text-primary transition-colors duration-100 ease-in-out
        hover:bg-active
        forced-colors:transition-none
        forced-colors:hover:text-[Highlight]
        [#--menu-toggle:focus-visible~[data-nav]_&]:ring-2
        [#--menu-toggle:focus-visible~[data-nav]_&]:ring-primary
      "
    >
      <List width="1.25rem" height="1.25rem" />
      <span class="sr-only">切换菜单</span>
    </label>
  </div>

  {/* nav-menu: 菜单项 - menu labels 已在配置层预处理，直接使用 set:html */}
  <div
    class="
      flex h-full flex-col justify-center
      max-lg:h-0 max-lg:overflow-hidden max-lg:opacity-0
      print:h-auto print:justify-start
      forced-colors:transition-none
      forced-colors:max-lg:border-t
      max-lg:motion-safe:update-fast:transition-[height_0.35s_cubic-bezier(0.4,0,0.2,1),opacity_0.25s_ease-out]
      max-lg:[#--menu-toggle:checked~[data-nav]_&]:h-11
      max-lg:[#--menu-toggle:checked~[data-nav]_&]:opacity-100
      max-lg:motion-safe:update-fast:[#--menu-toggle:checked~[data-nav]_&]:transition-[height_0.35s_cubic-bezier(0.4,0,0.2,1),opacity_0.25s_ease-in_0.1s]
      print:max-lg:[#--menu-toggle:not(:checked)~[data-nav]_&]:h-0
    "
  >
    <div
      class="
        flex max-h-full flex-col overflow-y-auto
        max-lg:block max-lg:overflow-x-auto max-lg:overflow-y-hidden
        max-lg:text-center max-lg:whitespace-nowrap
        print:block print:overflow-visible print:text-center
        print:whitespace-nowrap
      "
      data-overlayscrollbars-initialize
      data-nav-menu-scroll
    >
      {Object.entries(config.menu).map(([label, navItem]) => {
        const isObject = typeof navItem === 'object';
        const relativePath = isObject ? navItem.path : navItem;
        const path = getFullPath(relativePath);
        const ariaLabel = isObject ? navItem.ariaLabel : undefined;
        const recursive = !isObject || navItem.recursive !== false;

        return (
          <a
            class:list={[
              `
                flex h-nav-height shrink-0 items-center justify-center
                text-primary no-underline transition-colors duration-100
                ease-in-out
                hover:bg-active
                max-lg:inline-block max-lg:h-11 max-lg:px-5 max-lg:align-top
                max-lg:text-base/11
                print:inline-block print:h-11 print:px-5 print:align-top
                print:text-base/11
                forced-colors:border-[CanvasText] forced-colors:transition-none
                forced-colors:not-first:border-t
                forced-colors:max-lg:not-first:border-t-0
                forced-colors:max-lg:not-first:border-l
              `,
              isNavActive(path, recursive)
                ? `
                  bg-active forced-color-adjust-none
                  forced-colors:bg-[Highlight]
                  forced-colors:text-[HighlightText]
                `
                : 'forced-colors:hover:text-[Highlight]',
            ]}
            href={path}
            aria-label={ariaLabel}
          >
            <span
              class="
                inline-block truncate
                max-lg:inline max-lg:text-inherit
                print:inline print:text-inherit
              "
              set:html={label}
            />
          </a>
        );
      })}
    </div>
  </div>
</nav>

<NavigationController client:idle />
