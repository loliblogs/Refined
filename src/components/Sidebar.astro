---
import AuthorMeta from './AuthorMeta.astro';
import SearchBox from './SearchBox.astro';

import { getSearchUrl } from '@/utils/collection-paths';

import type { PageContext } from '@/types/content';


interface Props {
  pageContext: PageContext;
}

const { pageContext } = Astro.props;

// 根据collection获取配置和搜索URL
const collection = pageContext.collection;
const searchUrl = getSearchUrl(collection);

// 来自父级的 TOC 插槽（已在 PostPage 侧生成/处理）
const hasTocSlot = Astro.slots.has('default');
---

<aside
  data-aside
  class="
    relative h-full w-aside border-x border-soft bg-surface-aside
    max-lg:pointer-events-none max-lg:fixed max-lg:top-0 max-lg:left-0
    max-lg:z-90 max-lg:block max-lg:w-full max-lg:border-0 max-lg:bg-transparent
    print:hidden
  "
>
  {/* 遮罩已移至 BaseLayout 的 #--sidebar-toggle input，利用 input 自身作为点击目标 */}

  <div
    data-aside-inner
    class="
      relative flex size-full flex-col
      max-lg:pointer-events-auto max-lg:w-4/5 max-lg:max-w-sm
      max-lg:min-w-aside-min max-lg:-translate-x-full max-lg:bg-surface-aside
      max-lg:transition-transform max-lg:duration-300 max-lg:ease-in-out
      max-lg:[#--sidebar-toggle:checked~[data-aside]_&]:translate-x-0
    "
  >
    {/* 阅读进度条 - 固定在 aside 顶部，contain-strict 隔离避免触发外部布局重算 */}
    <div
      data-reading-progress-container
      class="
        pointer-events-none absolute inset-x-0 top-0 h-1 bg-soft/30 opacity-0
        transition-opacity duration-300 contain-strict
      "
      aria-hidden="true"
    >
      <div
        data-reading-progress-bar
        class="
          h-full w-full origin-left scale-x-(--progress,0) bg-linear-to-r
          from-primary to-secondary transition-transform duration-150 ease-out
        "
      />
    </div>

    {/* Mobile close button will be added via JavaScript */}

    {/* 搜索框区域 - 统一放在顶部，不滚动 */}
    <div class="
      shrink-0 px-6 pt-8 pb-4
      max-lg:p-4
    "
    >
      <SearchBox
        placeholder="搜索"
        searchUrl={searchUrl}
      />
    </div>

    {/* 根据是否有 TOC 插槽显示不同内容 */}
    {hasTocSlot
      ? (
          /* 内容区域 - 可滚动，滚动条在最右边 */
          <div
            class="min-h-0 flex-1 overflow-x-hidden overflow-y-auto"
            data-overlayscrollbars-initialize
            data-toc-container
          >
            <div class="
              h-full px-6
              max-lg:px-4
            "
            >
              {/* 使用来自 PostPage 的插槽内容（可能是明文 TOC 或加密占位） */}
              <slot />
            </div>
          </div>
        )
      : (
          /* AuthorMeta 在整个容器中居中 */
          <div class="min-h-0 flex-1 overflow-hidden">
            <div
              class="flex h-full flex-col overflow-x-hidden overflow-y-auto"
              data-overlayscrollbars-initialize
              data-authmeta-container
            >
              <div class="flex h-full flex-col">
                <div class="min-h-0 shrink grow basis-0" aria-hidden="true" />
                <div class="
                  shrink-0 px-6
                  max-lg:px-4
                "
                >
                  <AuthorMeta collection={collection} />
                </div>
                <div
                  class="
                    min-h-0 shrink grow basis-25
                    max-lg:basis-17
                  "
                  aria-hidden="true"
                />
              </div>
            </div>
          </div>
        )}
  </div>
</aside>
