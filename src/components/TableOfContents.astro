---
/**
 * 目录导航组件 - 从 slot 内容中提取标题并渲染目录
 * 极简设计：只用缩进区分层级，h2 带圆圈序号
 *
 * 为什么用 slot + cheerio 而不是 render() 返回的 headings？
 * headings 是从 markdown 源文件直接提取的原始文本，
 * 标题中的行内代码、数学公式等未经处理（如 `code` 和 $formula$ 会原样保留）。
 * 必须从渲染后的 HTML 提取，才能得到正确的、已处理的标题内容。
 */

import * as cheerio from 'cheerio';
import type { TocItem } from '@/types/utils';

export interface Props {
  /** 自定义样式类名 */
  className?: string;
  /** 最小显示层级 */
  minLevel?: number;
  /** 最大显示层级 */
  maxLevel?: number;
  /** 标题 */
  title?: string | undefined;
  /** 无目录时的提示文字 */
  emptyText?: string | undefined;
  /** 内容语言标记 */
  lang?: string | undefined;
}

const {
  className = '',
  minLevel = 1,
  maxLevel = 6,
  title = '目录',
  emptyText = '本文章没有目录',
  lang,
} = Astro.props;

const html = await Astro.slots.render('default');

const $ = cheerio.load(html);
const toc: TocItem[] = $('h1, h2, h3, h4, h5, h6').map((_, el) => ({
  level: parseInt(el.tagName[1] ?? '-1'),
  text: $(el).html() ?? '',
  id: $(el).attr('id') ?? '',
})).get();

// 过滤有效层级的标题
const filteredHeadings = toc.filter(
  h => h.level >= minLevel && h.level <= maxLevel,
);

// 找到实际的最小层级（可能是h1、h2或更深）
const actualMinLevel = filteredHeadings.length > 0
  ? Math.min(...filteredHeadings.map(h => h.level))
  : minLevel;

// 计算顶层标题的序号
let topLevelIndex = 0;
const itemsWithIndex = filteredHeadings.map((item) => {
  if (item.level === actualMinLevel) {
    topLevelIndex++;
    return { ...item, topLevelIndex };
  }
  return { ...item, topLevelIndex: null };
});
---

<nav
  data-toc
  class:list={['py-4', className]}
  aria-label={title}
>
  <h2 class="
    mb-4 border-b border-line pb-2 text-2xl font-bold text-primary opacity-80
  "
  >
    {title}
  </h2>

  {filteredHeadings.length > 1
    ? (
        <div {...(lang && { lang })}>
          {itemsWithIndex.map((item) => {
            // 计算相对于最小层级的偏移量
            const levelOffset = item.level - actualMinLevel;

            return (
              <a
                href={`#${item.id}`}
                class:list={[
                  `
                    group relative flex items-center gap-2 rounded-md py-1.5
                    text-secondary no-underline transition-colors
                    before:absolute before:inset-y-0 before:left-0 before:w-1
                    before:rounded-sm before:bg-primary before:opacity-0
                    before:transition-opacity before:duration-200
                    hover:bg-hover hover:text-primary
                    data-[active=true]:bg-hover data-[active=true]:font-medium
                    data-[active=true]:text-primary
                    data-[active=true]:before:opacity-100
                  `,
                  levelOffset === 0 && 'pl-3',
                  levelOffset === 1 && 'pl-7',
                  levelOffset === 2 && 'pl-10',
                  levelOffset === 3 && 'pl-13',
                  levelOffset === 4 && 'pl-16',
                  levelOffset >= 5 && 'pl-19',
                ]}
                data-toc-id={item.id}
              >
                {/* 顶层：圆圈序号；非顶层：小圆点 */}
                {item.topLevelIndex
                  ? (
                      <span
                        class="
                          inline-flex size-5 shrink-0 items-center
                          justify-center rounded-full bg-secondary text-xs
                          font-semibold text-surface transition-colors
                          group-hover:bg-primary
                          group-data-[active=true]:bg-primary
                        "
                      >
                        {item.topLevelIndex}
                      </span>
                    )
                  : (
                      <span
                        class="
                          size-1.5 shrink-0 rounded-full bg-muted
                          transition-colors
                          group-hover:bg-primary
                          group-data-[active=true]:bg-primary
                        "
                      />
                    )}

                {/* 标题文字 */}
                <span class="flex-1 truncate">
                  <Fragment set:html={item.text} />
                </span>
              </a>
            );
          })}
        </div>
      )
    : (
        <p class="text-sm text-muted">
          {emptyText}
        </p>
      )}
</nav>
