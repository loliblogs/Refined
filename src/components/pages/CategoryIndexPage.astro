---
/**
 * 分类索引页面组件 - 支持多collection
 * 完全兼容原始category/index.astro的行为
 */
import { FolderOpenIcon, FolderIcon } from '@phosphor-icons/react';

import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCategorySystem } from '@/utils/data-loader';
import { getCategoryUrl, getCategoryIndexUrl } from '@/utils/collection-paths';

import type { CollectionName } from '@/types/content';

interface Props {
  collection?: CollectionName;
}

const { collection = 'post' } = Astro.props;

// 获取分类数据（每个collection独立）
const categorySystem = await getCategorySystem(collection);
const topCategories = categorySystem.getRootNodes();
const stats = categorySystem.getBaseStats();
const popularCategories = categorySystem.getPopularNodes(10);

// 页面上下文
const pageContext = {
  path: getCategoryIndexUrl(collection),
  collection,
};
---

<BaseLayout
  title="分类 | 博客"
  description="浏览所有文章分类"
  pageContext={pageContext}
>
  {/* 页面标题 */}
  <header class="mb-8">
    <h1 class="mb-4 text-3xl font-bold">分类</h1>
    <p class="text-secondary">
      共
      {' '}
      {stats.totalNodes}
      {' '}
      个分类，最大深度
      {' '}
      {stats.maxLevel}
      {' '}
      级
    </p>
  </header>

  {/* 热门分类 */}
  <section class="mb-12">
    <h2 class="mb-4 text-2xl font-bold">热门分类</h2>
    <div class="
      grid grid-cols-5 gap-4
      max-lg:grid-cols-2
    "
    >
      {popularCategories.map(category => (
        <a
          href={getCategoryUrl(category.path, collection)}
          class="
            rounded-sm border p-4 text-center transition
            hover:bg-hover
          "
        >
          <div class="font-medium">{category.name}</div>
          <div class="mt-1 text-sm text-secondary">
            {category.count}
            {' '}
            篇
          </div>
        </a>
      ))}
    </div>
  </section>

  {/* 分类树
      注意：显示的是每个分类包含子分类的总文章数
      例如 Frontend(25) 包含了其所有子分类 React(15) Vue(10) 的文章总和 */}
  <section class="mb-12">
    <h2 class="mb-4 text-2xl font-bold">分类目录</h2>
    <div class="space-y-3">
      {topCategories.map(category => (
        <div>
          <a
            href={getCategoryUrl(category.path, collection)}
            class="
              flex items-center gap-2 text-lg font-semibold transition
              hover:text-link
            "
          >
            <span class="mr-0.5 text-secondary">
              <FolderOpenIcon size="1.25em" weight="duotone" />
            </span>
            {category.name}
            <span class="
              inline-flex font-normal text-muted
              before:content-['(']
              after:content-[')']
            "
            >
              {category.count}
            </span>
          </a>

          {category.childNodes.size > 0 && (
            <div class="mt-2 ml-6 space-y-3">
              {Array.from(category.childNodes).map(child => (
                <a
                  href={getCategoryUrl(child.path, collection)}
                  class="
                    flex items-center gap-2 text-lg text-primary transition
                    hover:text-link
                  "
                >
                  <span class="mr-0.5 text-muted">
                    <FolderIcon size="1.25em" weight="duotone" />
                  </span>
                  {child.name}
                  <span class="
                    inline-flex text-muted
                    before:content-['(']
                    after:content-[')']
                  "
                  >
                    {child.count}
                  </span>
                </a>
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
  </section>

  {/* 统计信息 */}
  <aside class="mt-12 rounded-lg bg-hover p-6 ring-2 ring-hover ring-inset">
    <h3 class="mb-2 text-lg font-bold">统计信息</h3>
    <ul class="space-y-1 text-sm">
      <li>
        分类总数:
        {stats.totalNodes}
      </li>
      <li>
        最大深度:
        {stats.maxLevel}
        {' '}
        级
      </li>
      <li>
        分类饱和度:
        {stats.averagePostsPerNode.toFixed(1)}
        篇 / 节点
      </li>
    </ul>
  </aside>
</BaseLayout>
