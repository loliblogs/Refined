---
/**
 * 文章详情页组件 - 支持多collection
 * 完全保持原始[...slug].astro的结构和行为
 */
import CalendarFill from '@phosphor-icons/core/assets/fill/calendar-fill.svg';
import TagFill from '@phosphor-icons/core/assets/fill/tag-fill.svg';
import FolderFill from '@phosphor-icons/core/assets/fill/folder-fill.svg';
import UserFill from '@phosphor-icons/core/assets/fill/user-fill.svg';
import LockSimple from '@phosphor-icons/core/assets/regular/lock-simple.svg';
import LockSimpleDuotone from '@phosphor-icons/core/assets/duotone/lock-simple-duotone.svg';
import CircleNotchBold from '@phosphor-icons/core/assets/bold/circle-notch-bold.svg';
import ArrowClockwiseFill from '@phosphor-icons/core/assets/fill/arrow-clockwise-fill.svg';

import BaseLayout from '@/layouts/BaseLayout.astro';
import { formatDate } from '@/utils/date-helpers';
import { getPostUrl, getCategoryUrl, getTagUrl, getArchiveUrl } from '@/utils/collection-paths';
import { getSiteConfig } from '@/config/site.config';
import Comments from '@/config/comments.config';
import EncryptWrapper from '../EncryptWrapper.astro';
import DecryptClient from '../DecryptClient';
import NavigationCard from '../NavigationCard.astro';
import TableOfContents from '../TableOfContents.astro';
import CachedContent from '../CachedContent.astro';

import type { CollectionName, Post } from '@/types/content';

interface Props {
  post: Post;
  prevPost: Post | null;
  nextPost: Post | null;
  collection?: CollectionName;
}

const { post, prevPost, nextPost, collection = 'post' } = Astro.props;
const { Content } = post;

// 提取第一个分类（如果存在）
const firstCategory = post.category[0];

// 决定是否显示评论
const showComments = post.comments;

// 获取配置
const siteConfig = getSiteConfig(collection);
const lockIconSize = siteConfig.author.avatar.width; // 锁图标尺寸与头像相同
const tocEmptyText = siteConfig.tocEmptyText ?? '本文章没有目录'; // 空目录提示文字

// 页面上下文（使用动态路径）
const pageContext = {
  path: getPostUrl(post.slug, collection),
  collection,
};
---

<BaseLayout
  title={post.title}
  description={post.description}
  pageContext={pageContext}
>
  <article>
    <header class="mb-8 border-b border-line pb-4">
      <h1 class="
        mb-4 text-4xl/tight font-normal text-primary
        max-lg:text-3xl
      "
      >
        {post.title}
      </h1>

      <div class="flex flex-wrap items-center gap-4 text-sm text-muted">
        <div class="flex items-center gap-1.5">
          <CalendarFill width="1rem" height="1rem" />
          <a
            href={`${getArchiveUrl(collection)}?focus=${formatDate(post.date)}`}
            class="
              transition-colors
              hover:text-primary
            "
          >
            <time datetime={post.date.toISOString()}>
              {formatDate(post.date)}
            </time>
          </a>
        </div>

        {post.updated && (
          <div class="flex items-center gap-1.5">
            <ArrowClockwiseFill width="1rem" height="1rem" />
            <time datetime={post.updated.toISOString()}>
              {formatDate(post.updated)}
            </time>
          </div>
        )}

        <div class="flex items-center gap-1.5">
          <UserFill width="1rem" height="1rem" />
          <span>{post.author}</span>
        </div>

        {firstCategory && (
          <div class="flex items-center gap-1.5">
            <FolderFill width="1rem" height="1rem" />
            <a
              href={getCategoryUrl(firstCategory, collection)}
              class="
                transition-colors
                hover:text-primary
              "
            >
              {firstCategory}
            </a>
          </div>
        )}
      </div>

      {post.tags.length > 0 && (
        <div class="mt-4 flex flex-wrap gap-2">
          {post.tags.map(tag => (
            <a
              href={getTagUrl(tag, collection)}
              class="
                inline-flex items-center gap-1 rounded-full bg-hover px-2.5 py-1
                text-xs text-secondary ring-2 ring-hover transition-colors
                duration-200 ring-inset
                hover:text-primary
              "
            >
              <TagFill width="0.75rem" height="0.75rem" />
              {tag}
            </a>
          ))}
        </div>
      )}
    </header>

    {/* 文章主体 - 加密时隐藏且不被pagefind索引 */}
    <div
      id="--article-body"
      data-markdown
      class:list={[
        'my-8 leading-markdown',
        post.encryption && 'hidden',
      ]}
      {...(!post.encryption && !post.draft && { 'data-pagefind-body': true })}
    >
      {post.encryption
        ? (
            <EncryptWrapper derivedKey={post.encryption.derivedKey} salt={post.encryption.salt}>
              <CachedContent cacheKey={post.id}>
                <Content />
              </CachedContent>
            </EncryptWrapper>
          )
        : (
            <CachedContent cacheKey={post.id}>
              <Content />
            </CachedContent>
          )}
    </div>

    {/* 解密UI - 与mardown-body并行，只在加密时显示 */}
    {post.encryption && (
      <div
        id="decrypt-panel"
        class="my-8 rounded-lg border border-line bg-surface p-6"
      >
        <div class="flex flex-col items-center gap-4">
          {/* 锁图标和提示 */}
          <div class="flex flex-wrap items-center gap-2 text-muted">
            <LockSimple width="1rem" height="1rem" />
            <span id="decrypt-prompt" set:html={post.encryption.prompt} />
          </div>

          {/* 辅助文本与可感知名称（使用可见的 prompt 作为描述） */}
          <label for="decrypt-password" class="sr-only">文章密码</label>

          {/* 输入和按钮 */}
          <div id="input-group" class="flex gap-4">
            <input
              type="password"
              id="decrypt-password"
              class="
                w-60 rounded-sm border border-line px-3 py-2 transition-colors
                duration-200
                focus:border-link focus:outline-none
              "
              placeholder={post.encryption.hint}
              autocomplete="off"
              aria-describedby="decrypt-prompt"
              aria-required="true"
              aria-invalid="false"
            />
            <button
              id="decrypt-button"
              type="button"
              class="
                relative flex w-18 items-center justify-center rounded-sm
                bg-link text-white transition-colors duration-200
                hover:bg-link-hover
                disabled:cursor-not-allowed disabled:opacity-50
              "
              aria-controls="--article-body"
              aria-describedby="decrypt-prompt"
            >
              <span id="button-text">解锁</span>
              <span
                id="button-loading"
                class="
                  absolute inset-0 hidden animate-spin items-center
                  justify-center
                "
              >
                <CircleNotchBold width="1.25rem" height="1.25rem" />
              </span>
            </button>
          </div>

          {/* 错误提示 - 可被读屏立即朗读 */}
          <div
            id="decrypt-error"
            class="hidden text-link"
            role="status"
            aria-live="assertive"
            aria-atomic="true"
          >
            <span id="error-text"></span>
          </div>
        </div>
      </div>
    )}

    <footer class="
      border-t border-line/50 pt-12
      print:hidden
    "
    >
      <nav>
        <div class="
          grid grid-cols-2 gap-12
          max-lg:grid-cols-1 max-lg:gap-8
        "
        >
          {prevPost
            ? (
                <NavigationCard
                  post={prevPost}
                  direction="prev"
                  collection={collection}
                />
              )
            : (
                <div class="invisible" />
              )}

          {nextPost
            ? (
                <NavigationCard
                  post={nextPost}
                  direction="next"
                  collection={collection}
                />
              )
            : (
                <div class="invisible" />
              )}
        </div>
      </nav>
    </footer>
  </article>

  {/* 解密客户端 - 只在有密码时加载 */}
  {post.encryption && <DecryptClient client:idle />}

  {/* 评论区 */}
  {showComments && (
    <section class="
      mt-12 border-t border-line pt-8
      print:hidden
    "
    >
      <Comments client:load />
    </section>
  )}

  {/* Sidebar slot：传递（已加密或明文）TOC 到侧边栏 */}
  <Fragment slot="sidebar">
    {post.encryption
      ? (
          <>
            {/* 加密占位符 - 大大的锁图标，上下左右居中 */}
            <div
              data-toc-placeholder
              class="flex h-full items-center justify-center text-secondary"
            >
              <LockSimpleDuotone width={lockIconSize} height={lockIconSize} />
            </div>

            {/* 加密数据 - 隐藏，供解密使用 */}
            <div class="hidden" data-toc-encrypted>
              <EncryptWrapper derivedKey={post.encryption.derivedKey} salt={post.encryption.salt}>
                <TableOfContents emptyText={tocEmptyText}>
                  <CachedContent cacheKey={post.id}>
                    <Content />
                  </CachedContent>
                </TableOfContents>
              </EncryptWrapper>
            </div>
          </>
        )
      : (
          <TableOfContents emptyText={tocEmptyText}>
            <CachedContent cacheKey={post.id}>
              <Content />
            </CachedContent>
          </TableOfContents>
        )}
  </Fragment>

</BaseLayout>
