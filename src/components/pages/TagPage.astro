---
/**
 * 标签页面组件 - 支持多collection
 * 完全兼容原始[...path].astro的行为
 */
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getTagUrl, getTagIndexUrl } from '@/utils/collection-paths';
import PostList from '../PostList.astro';
import TagCloud from '../TagCloud';
import PaginationNav from '../PaginationNav.astro';

import type { CollectionName } from '@/types/content';
import type { Post, Tag } from '@/types/content';

interface Props {
  tag: Tag;
  posts: Post[];
  ancestors: Tag[];
  relatedTags: Tag[];
  childTags: Tag[];
  currentPage: number;
  lastPage: number;
  collection?: CollectionName;
}

const {
  tag,
  posts,
  ancestors,
  relatedTags,
  childTags,
  currentPage,
  lastPage,
  collection = 'post',
} = Astro.props;

// 页面上下文
const pageContext = {
  path: getTagUrl(tag.path, collection),
  collection,
};

// 生成标题
const pageTitle = `标签: ${tag.name}`;
---

<BaseLayout
  title={pageTitle}
  description={`查看所有标记为"${tag.name}"的文章`}
  pageContext={pageContext}
>
  {/* 标签标题 */}
  <header class="mb-8">
    <h1 class="mb-2 text-3xl font-bold">
      标签:
      {' '}
      {tag.name}
    </h1>
    {/* 显示直接属于该标签的文章数（不包含子标签）
        使用 postIds.size 表示直接文章数，count 表示包含子标签的总数 */}
    <p class="text-secondary">
      共
      {' '}
      {tag.postIds.size}
      {' '}
      篇文章
    </p>

    {/* 面包屑导航 */}
    {ancestors.length > 0 && (
      <nav class="mt-4 text-sm">
        <a href={getTagIndexUrl(collection)} class="text-link">
          <span class="hover:underline">所有标签</span>
        </a>
        {ancestors.map(ancestor => (
          <>
            <span class="mx-2">/</span>
            <a href={getTagUrl(ancestor.path, collection)} class="text-link">
              <span class="hover:underline">{ancestor.name}</span>
            </a>
          </>
        ))}
        <span class="mx-2">/</span>
        <span class="text-primary">{tag.name}</span>
      </nav>
    )}
  </header>

  {/* 子标签 */}
  {childTags.length > 0 && (
    <section class="mb-8">
      <h2 class="mb-4 text-xl font-bold">子标签</h2>
      <div class={`
        grid grid-cols-4 gap-4
        max-lg:grid-cols-2
      `}
      >
        {childTags.map(child => (
          <a
            href={getTagUrl(child.path, collection)}
            class={`
              rounded border p-4 transition
              hover:bg-hover
            `}
          >
            <h3 class="font-semibold">{child.name}</h3>
            {/* 子标签显示包含其子标签的总文章数 */}
            <p class="text-sm text-secondary">
              {child.count}
              {' '}
              篇文章
            </p>
          </a>
        ))}
      </div>
    </section>
  )}

  {/* 文章列表 */}
  <main class="mb-8">
    <PostList posts={posts} collection={collection} />

    {/* 分页 */}
    <PaginationNav
      currentPage={currentPage}
      lastPage={lastPage}
      baseUrl={getTagUrl(tag.path, collection)}
    />
  </main>

  {/* 相关标签 */}
  {relatedTags.length > 0 && (
    <aside>
      <h2 class="mb-4 text-xl font-bold">相关标签</h2>
      <div class="min-h-64 rounded-lg bg-hover p-6">
        <TagCloud
          tags={relatedTags.map(t => [t.name, t.count, getTagUrl(t.path, collection)])}
          collection={collection}
          client:only="react"
        />
      </div>
    </aside>
  )}
</BaseLayout>
